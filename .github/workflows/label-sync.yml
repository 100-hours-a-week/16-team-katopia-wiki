name: Sync labels to BE/FE/CLOUD

on:
  push:
    paths:
      - ".github/labels.yml"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.LABEL_SYNC_TOKEN }}
      OWNER: 100-hours-a-week
      TARGET_REPOS: |
        16-team-katopia-be
        16-team-katopia-fe
        16-team-katopia-cloud

    steps:
      - uses: actions/checkout@v4

      - name: Delete all labels in target repos
        shell: bash
        run: |
          set -euo pipefail

          api() {
            curl -sS -H "Authorization: Bearer ${TOKEN}" \
                   -H "Accept: application/vnd.github+json" \
                   "$@"
          }

          for repo in ${TARGET_REPOS}; do
            echo "==> Deleting labels in ${OWNER}/${repo}"

            # list labels (paginate)
            page=1
            while :; do
              labels_json="$(api "https://api.github.com/repos/${OWNER}/${repo}/labels?per_page=100&page=${page}")"
              count="$(echo "$labels_json" | jq 'length')"
              if [ "$count" -eq 0 ]; then
                break
              fi

              echo "$labels_json" | jq -r '.[].name' | while IFS= read -r name; do
                enc_name="$(python3 - << 'PY'
import sys, urllib.parse
print(urllib.parse.quote(sys.argv[1], safe=""))
PY
"$name")"

                # delete label
                api -X DELETE "https://api.github.com/repos/${OWNER}/${repo}/labels/${enc_name}" >/dev/null || true
                echo "deleted: $name"
              done

              page=$((page+1))
            done
          done

      - name: Run Label Sync
        uses: srealmoreno/label-sync-action@v2
        with:
          token: ${{ secrets.LABEL_SYNC_TOKEN }}
          repositories: |
            100-hours-a-week/16-team-katopia-be
            100-hours-a-week/16-team-katopia-fe
            100-hours-a-week/16-team-katopia-cloud
